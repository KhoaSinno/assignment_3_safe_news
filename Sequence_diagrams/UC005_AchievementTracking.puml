@startuml SequenceAchievementTracking

actor "Người dùng" as user
boundary "UI: Chi tiết bài báo" as ui_detail
control "Ctrl: Tracking thời gian" as ctrl_tracking
control "Ctrl: Quản lý thành tựu" as ctrl_achievement
entity "Cloud Database" as database

activate user
user -> ui_detail: Mở trang chi tiết bài báo

activate ui_detail
ui_detail -> ctrl_tracking: Kiểm tra trạng thái đăng nhập
activate ctrl_tracking
ctrl_tracking --> ui_detail: Trạng thái đăng nhập
deactivate ctrl_tracking

alt#Gold #LightBlue Người dùng đã đăng nhập
    ui_detail -> ctrl_tracking: Bắt đầu bộ hẹn giờ tự động
    activate ctrl_tracking
    
    ui_detail --> user: Hiển thị nội dung bài báo
    
    == Theo dõi thời gian đọc ==
    ctrl_tracking -> ctrl_tracking: Đếm thời gian với bộ hẹn giờ định kỳ
    
    loop Mỗi giây
        ctrl_tracking -> ctrl_tracking: Cập nhật thời gian đã đọc
    end
    ' Enough time with condition
    alt #LightGreen Đọc đủ 30 giây liên tục
        ctrl_tracking -> ctrl_tracking: Kích hoạt ghi nhận hoàn thành bài báo
        
        ctrl_tracking -> ctrl_achievement: Thực hiện thống kê người dùng
        activate ctrl_achievement
        
        ctrl_achievement -> database: Yêu cầu cập nhật với transaction
        activate database
        
        == Cập nhật thống kê ==
        ctrl_achievement -> database: Tăng số bài đã đọc (+1)
        ctrl_achievement -> database: Cập nhật chuỗi hiện tại (nếu ngày mới)
        ctrl_achievement -> database: Thêm danh mục mới (nếu chưa có)
        
        database --> ctrl_achievement: Xác nhận cập nhật
        deactivate database
        
        == Kiểm tra thành tựu mới ==
        ctrl_achievement -> ctrl_achievement: Kiểm tra điều kiện thành tựu:
     
        
        alt#Gold #LightYellow Có thành tựu mới
            ctrl_achievement -> database: Lưu thành tựu mới
            activate database
            database --> ctrl_achievement: Xác nhận thành tựu
            deactivate database
            
            ctrl_achievement -> ui_detail: Thông báo thành tựu mới
            ui_detail --> user: Thông báo thành tựu mới
        end
        
        
        deactivate ctrl_achievement
        
    else #LightCoral Chưa đủ 30 giây
        ctrl_tracking -> ctrl_tracking: Tiếp tục đếm thời gian
    end
    
    deactivate ctrl_tracking

else #Gold Người dùng chưa đăng nhập
    ui_detail -> ctrl_tracking: Không theo dõi (im lặng)
    ctrl_tracking --> ui_detail: Bỏ qua tracking
end

@enduml
