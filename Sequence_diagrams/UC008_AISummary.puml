@startuml UC008_AISummary

actor "Người dùng" as user
boundary "UI: Chi tiết bài báo" as ui_detail
control "Ctrl: Quản lý bài báo" as ctrl_article
control "Ctrl: Xử lý tóm tắt" as ctrl_ai
entity "Database" as database
entity "Gemini API" as gemini_api

activate user
user -> ui_detail: Truy cập chi tiết bài báo

activate ui_detail
ui_detail -> ctrl_article: Lấy nội dung bài báo

activate ctrl_article
ctrl_article -> database: Truy vấn nội dung đầy đủ từ nguồn RSS
activate database
database --> ctrl_article: Nội dung bài báo
deactivate database
ctrl_article --> ui_detail: Nội dung bài báo
deactivate ctrl_article

ui_detail --> user: Hiển thị nội dung ban đầu

== Tạo tóm tắt với GenAI và tự động cache  ==

ui_detail -> ctrl_ai: Yêu cầu tóm tắt nội dung

activate ctrl_ai
ctrl_ai -> ctrl_ai: Kiểm tra độ dài nội dung

alt#Gold #Pink Nội dung quá ngắn
    ctrl_ai --> ui_detail: "Nội dung quá ngắn để tóm tắt"
    ui_detail --> user: Hiển thị thông báo
else #LightBlue Nội dung đủ dài
    ctrl_ai -> database: Kiểm tra cache tóm tắt có sẵn
    activate database
    database --> ctrl_ai: Kết quả cache (có/không)
    deactivate database
    
    alt#Gold #Orange Đã có tóm tắt trong cache
        ctrl_ai -> database: Lấy tóm tắt từ cache
        activate database
        database --> ctrl_ai: Tóm tắt đã lưu
        deactivate database
        ctrl_ai --> ui_detail: Tóm tắt từ cache
deactivate ctrl_ai
        ui_detail --> user: Hiển thị tóm tắt nhanh
    else #LightGreen Chưa có tóm tắt, tạo mới
        ctrl_ai -> ctrl_ai: Chuẩn bị prompt tóm tắt
activate ctrl_ai
        ctrl_ai -> gemini_api: Gửi yêu cầu tóm tắt với prompt và nội dung
        
        activate gemini_api
        gemini_api -> gemini_api: Xử lý và\ntóm tắt\nnội dung
        
        alt#Gold #LightBlue API limit exceeded
            gemini_api --> ctrl_ai: Lỗi giới hạn API
            ctrl_ai --> ui_detail: "Đã hết lượt tóm tắt miễn phí"
            deactivate ctrl_ai
            ui_detail --> user: Hiển thị thông báo lỗi
        else #Pink Network timeout
            gemini_api --> ctrl_ai: Lỗi timeout
            activate ctrl_ai
            ctrl_ai --> ui_detail: "Không thể kết nối AI, thử lại sau"
            deactivate ctrl_ai
            ui_detail --> user: Hiển thị thông báo lỗi
        else #LightGreen Thành công
            gemini_api --> ctrl_ai: Tóm tắt được tạo
        deactivate gemini_api
            activate ctrl_ai
            
            ctrl_ai -> ctrl_ai: Chuyển đổi và làm sạch dữ liệu
            
            ctrl_ai -> database: Lưu tóm tắt vào cache
            activate database
            database --> ctrl_ai: Xác nhận lưu thành công
            deactivate database
            
            ctrl_ai --> ui_detail: Tóm tắt hoàn thành
            deactivate ctrl_ai
            
            ui_detail --> user: Hiển thị tóm tắt
        end
    end
end


deactivate ui_detail
deactivate user

@enduml