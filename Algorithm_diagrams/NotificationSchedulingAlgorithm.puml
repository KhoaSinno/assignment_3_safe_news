@startuml NotificationSchedulingAlgorithm

start

:Background scheduler kích hoạt (mỗi 2 giờ);
note right
**INPUT:**
- scheduledTime: DateTime
- lastNotificationTime: DateTime

**PSEUDOCODE:**
```
FUNCTION scheduleNewsNotifications():
    users = getAllUsersWithNotificationsEnabled()
    
    FOR EACH user IN users:
        settings = getNotificationSettings(user.id)
        
        IF NOT settings.isEnabled THEN
            CONTINUE
        END IF
        
        // Kiểm tra quiet hours
        IF isInQuietHours(now(), settings.quietStart, settings.quietEnd) THEN
            CONTINUE
        END IF
        
        // Lấy tin mới từ lần thông báo cuối
        lastSent = getLastNotificationTime(user.id)
        newArticles = getNewArticlesSince(lastSent)
        
        // Lọc theo sở thích category
        relevantArticles = filterByUserPreferences(newArticles, settings)
        
        IF relevantArticles.length > 0 THEN
            // Chọn bài hay nhất để thông báo
            selectedArticle = selectBestArticle(relevantArticles)
            sendPushNotification(user, selectedArticle)
            updateLastNotificationTime(user.id, now())
        END IF
    END FOR
END FUNCTION

FUNCTION selectBestArticle(articles):
    // Ưu tiên: Breaking news > Sentiment positive > Latest
    RETURN articles.sort((a, b) => {
        IF a.category == "breaking_news" AND b.category != "breaking_news" THEN
            RETURN -1
        END IF
        
        IF a.sentiment != b.sentiment THEN
            RETURN b.sentiment - a.sentiment
        END IF
        
        RETURN b.published - a.published
    })[0]
END FUNCTION
```
end note

:Lấy danh sách users có bật notifications;

repeat
    :Chọn user tiếp theo;
    
    :Lấy NotificationSettings của user;
    
    if (isEnabled?) then (yes)
        if (Trong quiet hours?) then (no)
            :Lấy lastNotificationTime;
            :Tìm articles mới từ lastNotificationTime;
            
            if (Có articles mới?) then (yes)
                :Lọc theo categorySubscriptions;
                
                if (Có articles phù hợp?) then (yes)
                    :Chọn article tốt nhất;
                    note right
                    **Selection Criteria:**
                    1. Breaking news category
                    2. Highest sentiment score
                    3. Most recent published
                    end note
                    
                    :Tạo notification content;
                    :Gửi qua Firebase Cloud Messaging;
                    :Lưu vào notification history;
                    :Cập nhật lastNotificationTime;
                    
                    if (Gửi thành công?) then (yes)
                        :Log success;
                    else (no)
                        :Log error và retry sau;
                    endif
                endif
            endif
        else (yes)
            :Bỏ qua (quiet hours);
        endif
    else (no)
        :Bỏ qua (disabled);
    endif
    
repeat while (Còn user chưa xử lý?) is (yes)
-> (no)

:Lập lịch lần chạy tiếp theo (2 giờ);

stop

@enduml
