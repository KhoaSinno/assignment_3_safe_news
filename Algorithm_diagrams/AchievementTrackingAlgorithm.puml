@startuml AchievementTrackingAlgorithm

start

:Người dùng đọc bài báo >= 30 giây;
note right
**INPUT:** 
- userId: string
- articleId: string  
- readingDuration: int (seconds)
- category: string

**PSEUDOCODE:**
```
FUNCTION trackAchievement(userId, articleId, duration, category):
    IF duration < 30 THEN
        RETURN // Không đủ thời gian
    END IF
    
    stats = getUserStats(userId)
    stats.articlesRead += 1
    stats.readCategories.addUnique(category)
    
    // Cập nhật streak
    IF isToday(stats.lastReadDate) THEN
        // Đã đọc hôm nay rồi, không tăng streak
    ELSE IF isYesterday(stats.lastReadDate) THEN
        stats.currentStreak += 1
    ELSE
        stats.currentStreak = 1 // Reset streak
    END IF
    
    stats.lastReadDate = today()
    
    newAchievements = checkAllAchievements(stats)
    FOR EACH achievement IN newAchievements:
        stats.unlockedAchievements.add(achievement)
        sendAchievementNotification(userId, achievement)
    END FOR
    
    saveUserStats(stats)
    RETURN newAchievements
END FUNCTION
```
end note

:Lấy UserAchievementStats từ Firestore;

if (readingDuration >= 30?) then (yes)
    :stats.articlesRead += 1;
    :Thêm category vào readCategories (unique);
    
    if (Đã đọc hôm nay?) then (yes)
        :Giữ nguyên currentStreak;
    elseif (Đọc ngày hôm qua?) then (yes)
        :currentStreak += 1;
    else (no)
        :currentStreak = 1 (reset);
    endif
    
    :lastReadDate = today();
    
    :Kiểm tra điều kiện tất cả achievements;
    note right
    **Achievement Conditions:**
    - NEWBIE: Mặc định khi đăng ký
    - FIRST_READ: articlesRead >= 1
    - DAILY_READER: articlesRead >= 5 trong ngày
    - EXPLORER: readCategories.length >= 3
    - WEEK_STREAK: currentStreak >= 7
    - BOOKWORM: articlesRead >= 50
    end note
    
    if (Có achievement mới?) then (yes)
        :Thêm vào unlockedAchievements;
        :Gửi thông báo achievement;
        :Cập nhật UI badge;
    endif
    
    :Lưu stats vào Firestore;
    :Trả về danh sách achievement mới;
    
else (no)
    :Không tracking (< 30s);
endif

stop

@enduml
